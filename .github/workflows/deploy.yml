name: Continuous Deployment to EC2 (Techcrush)

# Defines the workflow triggers
on:
  # 1. Automatic Trigger: Runs on a push to the 'main' branch
  push:
    branches:
      - main
    # Only deploy if these common website files change
    paths:
      - '**.html'
      - '**.php'
      - '**.css'
      - '**.js'
      - '**.jpg'
      
  # 2. Manual Trigger: Enables the "Run workflow" button
  workflow_dispatch:
  

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Environment variables visible within this job
    env:
      EC2_USER: ubuntu
      DEPLOY_DIR: /var/www/techcrush
      
    steps:
      - name: â¬‡ï¸ Checkout Repository Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Deploy Code via SSH and Git Pull
        uses: appleboy/ssh-action@v1.0.1
        with:
          # Host/User/Key inputs (Using your confirmed secret names)
          host: ${{ secrets.AWS_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          
          # Execution settings
          script_stop: true # Crucial: stops immediately on any error
          
          # The remote shell script to execute on the EC2 instance
          script: |
            echo "ðŸš€ Starting robust remote deployment..."
            
            DEPLOY_DIR="/var/www/techcrush"
            REPO_URL="https://github.com/${{ github.repository }}" 
            
            # --- 1. Setup Directory and Permissions (Ensure ownership is correct) ---
            sudo mkdir -p ${DEPLOY_DIR}
            sudo chown -R ubuntu:ubuntu ${DEPLOY_DIR}
            
            # --- 2. Remote Clone or Pull ---
            echo "Attempting to update code via git pull..."

            if [ ! -d "${DEPLOY_DIR}/.git" ]; then
              # Clone if directory is missing (First run)
              git clone ${REPO_URL} ${DEPLOY_DIR} 2>&1 || { echo "FATAL ERROR: Git Clone failed." >&2; exit 1; }
            else
              # FIX FOR SUBSEQUENT RUNS (This is where the error occurred before)
              cd ${DEPLOY_DIR}
              
              # Ensure the repository is clean (stash any files that block the pull/reset)
              git stash push --include-untracked -m "CI/CD auto-stash" || true
              
              # Fetch all changes and confirm success
              git fetch --all 2>&1 || { echo "FATAL ERROR: Git Fetch failed." >&2; exit 1; }
              
              # Hard reset to the latest main commit
              git reset --hard origin/main 2>&1 || { echo "FATAL ERROR: Git Reset failed." >&2; exit 1; }
            fi
            
            # --- 3. Set Web Server Permissions ---
            echo "Setting web server ownership (www-data) and permissions..."
            sudo chown -R www-data:www-data ${DEPLOY_DIR}
            sudo find ${DEPLOY_DIR} -type d -exec sudo chmod 755 {} \;
            sudo find ${DEPLOY_DIR} -type f -exec sudo chmod 644 {} \;

            # --- 4. Restart Web Service ---
            if command -v nginx >/dev/null 2>&1; then
              echo "Restarting nginx..."
              sudo systemctl restart nginx || true
            elif command -v apache2ctl >/dev/null 2>&1; then
              echo "Restarting apache2..."
              sudo systemctl restart apache2 || true
            else
              echo "Warning: No web server found to restart."
            fi
            
            echo "âœ… Deployment finished."