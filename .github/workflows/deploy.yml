name: Continuous Deployment to EC2

# Trigger this workflow on pushes to the 'main' branch
on:
  push:
    branches:
      - main
    # Only run the deployment if specific website files are modified
    paths:
      - '**.html'
      - '**.php'
      - '**.css'
      - '**.js'
      - 'index.html' # Explicitly list key files if needed

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Environment variables for the job
    env:
      EC2_USER: ubuntu
      DEPLOY_DIR: /var/www/techcrush
      
    # Security note: These secrets must be configured in your GitHub repository settings.
    # We use secrets for sensitive data like IP and the private key.
    # EC2_PUBLIC_IP: Store the IP (e.g., 18.234.56.78)
    # SSH_PRIVATE_KEY: Store the contents of the .pem file.
    
    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      - name: ⚙️ Deploy to EC2 via SCP and SSH
        uses: appleboy/ssh-action@v1.0.1
        with:
          # SSH connection details from GitHub Secrets
          host: ${{ secrets.AWS_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          
          # SCP command to copy ALL files in the repository to the EC2 target directory
          script_stop: true # Stop if any command fails
          script: |
            echo "Starting remote deployment on EC2..."
            
            # 1. Create and set permissions for the target directory
            sudo mkdir -p ${{ env.DEPLOY_DIR }}
            sudo chown -R ${{ env.EC2_USER }}:${{ env.EC2_USER }} ${{ env.DEPLOY_DIR }}
            
            # 2. Upload/Sync the files from the GitHub Runner to EC2
            # The 'source' directory is the GitHub workspace ('.')
            rsync -avz --exclude '.git/' --exclude '.github/' ./ ${{ env.EC2_USER }}@${{ secrets.EC2_PUBLIC_IP }}:${{ env.DEPLOY_DIR }}/
            
            # 3. Reset web server permissions
            echo "Setting ownership (www-data) and permissions..."
            sudo chown -R www-data:www-data ${{ env.DEPLOY_DIR }}
            
            # 4. Restart web service
            if command -v nginx >/dev/null 2>&1; then
              echo "Restarting nginx..."
              sudo systemctl restart nginx || true
            elif command -v apache2ctl >/dev/null 2>&1; then
              echo "Restarting apache2..."
              sudo systemctl restart apache2 || true
            else
              echo "Warning: No web server found to restart."
            fi
            
            echo "Deployment finished."