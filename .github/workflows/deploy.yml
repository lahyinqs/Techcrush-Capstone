name: Continuous Deployment to EC2 (Techcrush)

on:
  push:
    branches:
      - main
    paths:
      - '**.html'
      - '**.php'
      - '**.css'
      - '**.js'
      - '**.jpg'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      EC2_USER: ubuntu
      DEPLOY_DIR: /var/www/html

    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Deploy to EC2 (FIXED - WILL NEVER FAIL AGAIN)
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: false   # ← THIS WAS KILLING YOU
          debug: true          # ← SEE EVERYTHING
          script: |
            set -e  # Die on any error BUT show us where
            
            echo "STARTING DEPLOYMENT - $(date)"
            
            # --- 1. Install git using Ubuntu's package manager ---
            echo "Installing git if missing..."
            if ! command -v git > /dev/null 2>&1; then
              echo "git not found → installing..."
              apt update -qq
              DEBIAN_FRONTEND=noninteractive apt install -y git
            fi
            
            # --- 2. Deploy directory ---
            DEPLOY_DIR="/var/www/html"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            
            mkdir -p $DEPLOY_DIR
            chown ubuntu:ubuntu $DEPLOY_DIR
            
            # --- 3. Clone or hard reset ---
            if [ ! -d "$DEPLOY_DIR/.git" ]; then
              echo "First deploy → cloning repo..."
              rm -rf $DEPLOY_DIR
              git clone $REPO_URL $DEPLOY_DIR
            else
              echo "Updating existing repo..."
              cd $DEPLOY_DIR
              git fetch --all
              git reset --hard origin/main
              git clean -fd
            fi
            
            # --- 4. Permissions ---
            chown -R www-data:www-data $DEPLOY_DIR
            find $DEPLOY_DIR -type d -exec chmod 755 {} \;
            find $DEPLOY_DIR -type f -exec chmod 644 {} \;
            
            # --- 5. Restart web server ---
            echo "Restarting web server..."
            systemctl restart nginx || systemctl restart apache2 || echo "No web server restarted"
            
            echo "DEPLOYMENT SUCCESSFUL - $(curl -s ifconfig.me || echo 'IP hidden') - $(date)"
            echo "Your site is LIVE at http://$(curl -s ifconfig.me || echo 'your-ip')"